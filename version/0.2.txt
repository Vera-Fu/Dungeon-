#define _CRT_SECURE_NO_WARNINGS

#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<math.h>
#include<Windows.h>
#include<time.h>
#include"conioex.h"

#define MAX_MAP 15

//------------è‡ªå®šä¹‰ç»“æ„ä½“------------
typedef enum {
    DISP_START = 0,		
    DISP_LOAD,			
    DISP_END,		
}SCENE;

typedef struct {
    int x;
    int y;
    int potionNum;
    int charaNum;
    int gold;
}PLAYER;

typedef struct {
    int x;              //æ­¤åŒºåŸŸçš„xåæ ‡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç©å®¶çš„xåæ ‡
    int y;              //æ­¤åŒºåŸŸçš„yåæ ‡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç©å®¶çš„yåæ ‡
    int index;          //åŒºåŸŸç±»å‹:1.å•†åº— 2.ç©ºæˆ¿ 3.å›å¤æˆ¿ï¼ˆå…è´¹ï¼‰ 4.æ‹›å‹Ÿæˆ¿ 5.éšæœºæˆ¿ 6.æˆ˜æ–—æˆ¿ 7.bossæˆ¿ 8.ä¸‹ä¸€å±‚æ¥¼æ¢¯ 9.åˆå§‹æˆ¿
    int isCheck;        //æ­¤åŒºåŸŸæ˜¯å¦å·²æ¸…é™¤
    int isUp;           //æ˜¯å¦æœ‰å‘ä¸Šçš„è·¯
    int isDown;         //æ˜¯å¦æœ‰å‘ä¸‹çš„è·¯
    int isLeft;         //æ˜¯å¦æœ‰å‘å·¦çš„è·¯
    int isRight;        //æ˜¯å¦æœ‰å‘å³çš„è·¯
}MAPS;

typedef struct {
    char name[31];
    int hp;
    int atk;
    int def;
    int spd;
    int eva;
    int cri;
}STATUS;


//------------å£°æ˜ç»“æ„ä½“------------
MAPS map[MAX_MAP];

//------------å…¨å±€å˜é‡å£°æ˜------------
int G_floor;
int G_checkMapNum;

//------------å‡½æ•°å£°æ˜------------
void title();               //ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
void runGame();
void moveMent(PLAYER* player, MAPS* map);
void mapsPaint(MAPS* map);
int mapsType();
void mapsPaint1();

void hideCursor();          //cursorã‚’éš ã•ã›ã¦

int main() {
    hideCursor();
    title();

    return 0;
}

//ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
void title() {
    int index = 0;
    while (1)
    {
        gotoxy(50, 5);
        printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“");
        gotoxy(50, 6);
        printf("â”ƒ%sâ”ƒ", "  â– Dungeonâ–  ");
        gotoxy(50, 7);
        printf("â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›");
        switch (index)
        {
        case DISP_START:
            gotoxy(53, 15);
            textattr(0x70);
            printf("ã‚²ãƒ¼ãƒ é–‹å§‹");
            textattr(0x0F);
            gotoxy(52, 17);
            printf("ã‚²ãƒ¼ãƒ ãƒ­ãƒ¼ãƒ‰");
            gotoxy(53, 19);
            printf("ã‚²ãƒ¼ãƒ çµ‚äº†");
            rewind(stdin);
            break;
        case DISP_LOAD:
            gotoxy(53, 15); 
            printf("ã‚²ãƒ¼ãƒ é–‹å§‹");          
            gotoxy(52, 17);
            textattr(0x70);
            printf("ã‚²ãƒ¼ãƒ ãƒ­ãƒ¼ãƒ‰");
            gotoxy(53, 19);
            textattr(0x0F);
            printf("ã‚²ãƒ¼ãƒ çµ‚äº†");
            rewind(stdin);
            break;
        case DISP_END:
            gotoxy(53, 15);       
            printf("ã‚²ãƒ¼ãƒ é–‹å§‹");
            gotoxy(52, 17);
            printf("ã‚²ãƒ¼ãƒ ãƒ­ãƒ¼ãƒ‰");
            gotoxy(53, 19);
            textattr(0x70);
            printf("ã‚²ãƒ¼ãƒ çµ‚äº†");
            textattr(0x0F);
            rewind(stdin);
            break;
        default:
            break;
        }        
        if (inport(PK_UP))
        {
            index--;
            if (index < 0)
            {
                index = 2;
            }
            reinport();
            clrscr();
        }
        if (inport(PK_DOWN))
        {
            index++;
            if (index > 2)
            {
                index = 0;
            }
            reinport();
            clrscr();
        }

        if (inport(PK_ENTER))
        {
            switch (index)
            {
            case DISP_START:
                runGame();
                break;
            case DISP_LOAD:
                break;
            case DISP_END:
                return;
            default:
                break;
            }
        }                    
    }
}

void runGame() {
    clrscr();
    G_floor = 1;
    G_checkMapNum = 1;
    PLAYER player = { 5, 9, 0, 0, 10};
    gotoxy(player.x, player.y);
    printf("â™€");
    mapsPaint1();
    moveMent(&player, map);
    getchar();
}

void moveMent(PLAYER* player, MAPS* map) {
    while (1)
    {     
        gotoxy(player->x, player->y);
        printf("â™€");
        //å½“è¯¥åŒºåŸŸå·²è¢«æ¢ç´¢ï¼Œä¾¿å°†å…¶æ˜¾ç¤º
        for (int i = 0; i < MAX_MAP; i++)
        {
            if ((map + i)->isCheck == 1)
            {
                mapsPaint(map + i);
            }
        }
        //ç©å®¶å‘ä¸Šç§»åŠ¨çš„å¤„ç†
        if (inport(PK_UP))
        {
            for (int i = 0; i < MAX_MAP; i++)
            {
                if (player->x == (map + i)->x && player->y - 5 == (map + i)->y && (map + i)->isDown == 1)
                {
                    player->y -= 5;
                    if ((map + i)->isCheck == 0)
                    {
                        (map + i)->isCheck = 1;
                        G_checkMapNum += 1;
                    }
                    break;
                }
            }
            reinport();
            clrscr();
        }
        //ç©å®¶å‘ä¸‹ç§»åŠ¨çš„å¤„ç†
        if (inport(PK_DOWN))
        {
            for (int i = 0; i < MAX_MAP; i++)
            {
                if (player->x == (map + i)->x && player->y + 5 == (map + i)->y && (map + i)->isUp == 1)
                {
                    player->y += 5;
                    if ((map + i)->isCheck == 0)
                    {
                        (map + i)->isCheck = 1;
                        G_checkMapNum += 1;
                    }
                    break;
                }
            }
            reinport();
            clrscr();
        }
        //ç©å®¶å‘å·¦ç§»åŠ¨çš„å¤„ç†
        if (inport(PK_LEFT))
        {
            for (int i = 0; i < MAX_MAP; i++)
            {
                if (player->x - 10 == (map + i)->x && player->y == (map + i)->y && (map + i)->isRight == 1)
                {
                    player->x -= 10;
                    if ((map + i)->isCheck == 0)
                    {
                        (map + i)->isCheck = 1;
                        G_checkMapNum += 1;
                    }
                    break;
                }
            }
            reinport();
            clrscr();
        }
        //ç©å®¶å‘å³ç§»åŠ¨çš„å¤„ç†
        if (inport(PK_RIGHT))
        {
            for (int i = 0; i < MAX_MAP; i++)
            {
                if (player->x + 10 == (map + i)->x && player->y == (map + i)->y && (map + i)->isLeft == 1)
                {
                    player->x += 10;
                    if ((map + i)->isCheck == 0)
                    {
                        (map + i)->isCheck = 1;
                        G_checkMapNum += 1;
                    }
                    break;
                }
            }
            reinport();
            clrscr();
        }
    }
}

//åŒºåŸŸç»˜åˆ¶
void mapsPaint(MAPS* map) {
    if (map->index == 0)
    {
       map->index = mapsType();
    }
    if (map->isUp == 1)
    {
        gotoxy(map->x + 2, map->y);
        printf("â”ƒ");
    }
    if (map->isDown == 1)
    {
        gotoxy(map->x + 2, map->y + 4);
        printf("â”ƒ");
    }
    if (map->isLeft == 1)
    {
        gotoxy(map->x - 2, map->y + 2);
        printf("â”");
    }
    if (map->isRight == 1)
    {
        gotoxy(map->x + 6, map->y + 2);
        printf("â”");
    }
    gotoxy(map->x, map->y + 1);
    printf("â– â– â– ");
    gotoxy(wherex() - 6, wherey() + 1);
    printf("â–   â– ");
    gotoxy(wherex() - 6, wherey() + 1);
    printf("â– â– â– ");
    switch (map->index)
    {
    case 1:
        gotoxy(map->x + 2, map->y + 2);
        printf("ï¿¥");
        break;
    case 2:
        gotoxy(map->x + 2, map->y + 2);
        printf("â– ");
        break;
    case 3:
        gotoxy(map->x + 2, map->y + 2);
        printf("â—‡");
        break;
    case 4:
        gotoxy(map->x + 2, map->y + 2);
        printf("ğŸ”¹");
        break;
    case 5:
        gotoxy(map->x + 2, map->y + 2);
        printf("ï¼Ÿ");
        break;
    case 6:
        gotoxy(map->x + 2, map->y + 2);
        printf("â–³");
        break;
    case 7:
        gotoxy(map->x + 2, map->y + 2);
        printf("â–²");
        break;
    case 8:
        gotoxy(map->x + 2, map->y + 2);
        printf("â—‹");
        break;
    case 9:
        gotoxy(map->x + 2, map->y + 2);
        printf("â—");
        break;
    default:
        break;
    }
    
}

int mapsType()
{
    int index = 0;
    if (G_checkMapNum == 8)
    {
        if (G_floor == 3)
        {
            index = 7;
        }
        else
        {
            index = 8;
        }
    }
    else
    {
        srand((unsigned int)time(NULL));
        int a = rand() % 100;               //ç”¨äºåˆ¤æ–­è¯¥åŒºåŸŸç±»å‹
        if (a >= 0 && a < 30)
        {
            index = 1;
        }
        if (a >= 30 && a < 35)
        {
            index = 2;
        }
        if (a >= 35 && a < 40)
        {
            index = 3;
        }
        if (a >= 40 && a < 50)
        {
            index = 4;
        }
        if (a >= 50 && a < 70)
        {
            index = 5;
        }
        if (a >= 70 && a < 100)
        {
            index = 6;
        }
    }
    return index;
}

//å…³å¡1çš„åœ°å›¾ç»˜åˆ¶
void mapsPaint1() {
    gotoxy(5, 10);
    map[0] = { wherex(), wherey() - 1, 9, 1, 1, 1, 0, 1 };      //(x,y,index,isCheck,isUp,isDown,isLeft,isRight);
    gotoxy(5, 5);
    map[1] = { wherex(), wherey() - 1, 0, 0, 0, 1, 0, 0 };
    gotoxy(5, 15);
    map[2] = { wherex(), wherey() - 1, 0, 0, 1, 0, 0, 1 };
    gotoxy(15, 10);
    map[3] = { wherex(), wherey() - 1, 0, 0, 0, 0, 1, 1 };
    gotoxy(25, 10);
    map[4] = { wherex(), wherey() - 1, 0, 0, 1, 0, 1, 1 };
    gotoxy(25, 5);
    map[5] = { wherex(), wherey() - 1, 0, 0, 0, 1, 0, 1 };
    gotoxy(35, 5);
    map[6] = { wherex(), wherey() - 1, 0, 0, 0, 1, 1, 0 };
    gotoxy(35, 10);
    map[7] = { wherex(), wherey() - 1, 0, 0, 1, 0, 1, 1 };
    gotoxy(45, 10);
    map[8] = { wherex(), wherey() - 1, 0, 0, 0, 0, 1, 0 };
    gotoxy(15, 15);
    map[9] = { wherex(), wherey() - 1, 0, 0, 0, 0, 1, 1 };
    gotoxy(25, 15);
    map[10] = { wherex(), wherey() - 1, 0, 0, 0, 0, 1, 0 };
}

//cursorã‚’éš ã•ã›ã¦
void hideCursor() {
    CONSOLE_CURSOR_INFO cur;
    cur.dwSize = 1;
    cur.bVisible = 0;
    SetConsoleCursorInfo(GetStdHandle(STD_OUTPUT_HANDLE), &cur);
}


